# OpenRV release build: triggered on push of tags matching v*
# Builds from upstream AcademySoftwareFoundation/OpenRV at the tag.
# Jobs: linux-rocky9 (required), linux-ubuntu (optional), windows (required), release
name: OpenRV Release

on:
  push:
    tags:
      - 'v*'

env:
  OPENRV_TAG: ${{ github.ref_name }}
  OPENRV_REPO: https://github.com/AcademySoftwareFoundation/OpenRV.git

jobs:
  linux-rocky9:
    name: Linux (Rocky 9)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build OpenRV (Rocky 9)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ci/linux/Dockerfile.rocky9
          load: true
          tags: openrv-build-rocky9
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: false

      - name: Run OpenRV build (Rocky 9)
        run: |
          mkdir -p out
          docker run --rm \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-rocky9 \
            -v "${{ github.workspace }}/out:/out" \
            openrv-build-rocky9

      - name: Upload Rocky9 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky9
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-rocky9-x86_64.tar.gz

  linux-ubuntu:
    name: Linux (Ubuntu 22.04, experimental)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build OpenRV (Ubuntu 22.04)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ci/linux/Dockerfile.ubuntu22.04
          load: true
          tags: openrv-build-ubuntu
          cache-from: type=gha
          cache-to: type=gha,mode=max
          push: false

      - name: Run OpenRV build (Ubuntu 22.04)
        run: |
          mkdir -p out
          docker run --rm \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-ubuntu22.04 \
            -v "${{ github.workspace }}/out:/out" \
            openrv-build-ubuntu

      - name: Upload Ubuntu artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: linux-ubuntu
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-ubuntu22.04-x86_64.tar.gz

  windows:
    name: Windows
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone OpenRV (for pip cache key)
        run: |
          git clone --depth 1 --branch "${{ env.OPENRV_TAG }}" "${{ env.OPENRV_REPO }}" openrv-src
        shell: bash

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: openrv-src/requirements.txt

      - name: Ensure python3.exe
        run: |
          $py = (Get-Command python -ErrorAction SilentlyContinue).Source
          if ($py) {
            $dir = Split-Path $py
            $py3 = Join-Path $dir 'python3.exe'
            if (-not (Test-Path $py3)) { Copy-Item $py $py3 }
          }

      - name: Cache Qt
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: C:\Qt
          key: openrv-qt-6.5.3-msvc2019

      - name: Install Qt 6.5.3
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop 6.5.3 win64_msvc2019_64 -O C:\Qt -m qtwebchannel qtwebengine qtwebsockets qtmultimedia qtpositioning
        env:
          QT_HOME: C:\Qt\6.5.3\msvc2019_64

      - name: Cache Strawberry Perl
        id: cache-perl
        uses: actions/cache@v4
        with:
          path: C:\Strawberry
          key: openrv-strawberryperl

      - name: Install Strawberry Perl
        if: steps.cache-perl.outputs.cache-hit != 'true'
        run: choco install strawberryperl -y

      - name: Cache Rust
        id: cache-rust
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.USERPROFILE }}\.cargo
            ${{ env.USERPROFILE }}\.rustup
          key: openrv-rust

      - name: Install Rust
        if: steps.cache-rust.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe -UseBasicParsing
          .\rustup-init.exe -y
        shell: pwsh

      - name: Cache MSYS2
        id: cache-msys2
        uses: actions/cache@v4
        with:
          path: C:\msys64
          key: openrv-msys2-v1

      - name: Install MSYS2 and build tools
        if: steps.cache-msys2.outputs.cache-hit != 'true'
        run: |
          choco install msys2 -y
          $env:Path = "C:\msys64\usr\bin;$env:Path"
          bash -lc "pacman -Sy --noconfirm --needed mingw-w64-x86_64-autotools mingw-w64-x86_64-glew mingw-w64-x86_64-libarchive mingw-w64-x86_64-make mingw-w64-x86_64-meson mingw-w64-x86_64-toolchain autoconf automake bison flex git libtool nasm p7zip patch unzip zip"

      - name: Setup MSVC (nmake for OpenSSL build)
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0, 18.0)'

      - name: Build OpenRV (Windows)
        run: |
          # PATH order per OpenRV docs: CMake, Python, Rust, MSYS2 mingw64/bin, then rest, Strawberry last.
          # Keep VS in PATH so OpenSSL build (make_openssl.py -> nmake) and Python wheel builds can find cl/nmake.
          $cmakeBin = "C:\Program Files\CMake\bin"
          $pyBin = (Split-Path (Get-Command python).Source)
          $env:Path = "$cmakeBin;$pyBin;$env:USERPROFILE\.cargo\bin;C:\msys64\mingw64\bin;C:\msys64\usr\bin;$env:Path;C:\Strawberry\perl\bin"
          $env:QT_HOME = "C:\Qt\6.5.3\msvc2019_64"
          $env:BASH_EXE = "C:\msys64\usr\bin\bash.exe"
          $env:WIN_PERL = "C:/Strawberry/perl/bin"
          $env:MSYSTEM = "MINGW64"
          # Mitigate Python wheel build errors (e.g. OpenTimelineIO) from MSVC FileTracker on Windows
          $env:CL = "/FS"
          $env:DISTUTILS_USE_SDK = "1"
          .\ci\windows\build_windows.ps1 -Tag '${{ env.OPENRV_TAG }}' -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Package OpenRV (Windows)
        run: |
          .\ci\windows\package_windows.ps1 -OpenRVRoot "C:\OpenRV" -Tag '${{ env.OPENRV_TAG }}' -OutDir dist
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: dist/OpenRV-${{ env.OPENRV_TAG }}-windows-x86_64.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [linux-rocky9, windows]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: OpenRV ${{ github.ref_name }}
          draft: false
          files: |
            release-artifacts/linux-rocky9/*
            release-artifacts/windows/*
            release-artifacts/linux-ubuntu/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
