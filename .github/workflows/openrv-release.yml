# OpenRV release build: triggered on push of tags matching v*
# Builds from upstream AcademySoftwareFoundation/OpenRV at the tag.
# Jobs: linux-rocky9 (required), linux-ubuntu (optional), windows (required), release
name: OpenRV Release

on:
  push:
    tags:
      - 'v*'

env:
  OPENRV_TAG: ${{ github.ref_name }}
  OPENRV_REPO: https://github.com/AcademySoftwareFoundation/OpenRV.git

jobs:
  linux-rocky9:
    name: Linux (Rocky 9)
    runs-on: ubuntu-latest
    continue-on-error: false
    if: false # DISABLED
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      # Resolve tag to commit SHA so cache key changes when the tag is overwritten
      - name: Get OpenRV tag commit SHA
        id: openrv-sha
        run: |
          SHA=$(git ls-remote "${{ env.OPENRV_REPO }}" "refs/tags/${{ env.OPENRV_TAG }}^{}" 2>/dev/null | cut -f1)
          [ -z "$SHA" ] && SHA=$(git ls-remote "${{ env.OPENRV_REPO }}" "refs/tags/${{ env.OPENRV_TAG }}" 2>/dev/null | cut -f1)
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "Resolved ${{ env.OPENRV_TAG }} to ${SHA}"

      - name: Restore OpenRV clone (Dockerfile context)
        id: openrv-cache
        uses: actions/cache@v4
        with:
          path: openrv-src
          key: openrv-rocky9-${{ env.OPENRV_TAG }}-${{ steps.openrv-sha.outputs.sha }}

      - name: Clone OpenRV
        if: steps.openrv-cache.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch "${{ env.OPENRV_TAG }}" "${{ env.OPENRV_REPO }}" openrv-src

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build vanilla Docker image (upstream Rocky 9 Dockerfile)
        uses: docker/build-push-action@v6
        with:
          context: openrv-src
          file: openrv-src/dockerfiles/Dockerfile.Linux-Rocky9-CY2024
          load: true
          tags: openrv-rocky9-base
          cache-from: type=gha,scope=rocky9
          cache-to: type=gha,mode=max,scope=rocky9
          push: false

      # Use host Docker (not Buildx) so FROM openrv-rocky9-base resolves from the image loaded in the previous step
      - name: Build extended Docker image (vanilla + GL/devel packages)
        run: docker build -f ci/linux/Dockerfile.rocky9-cy2024 -t openrv-build-rocky9 .

      - name: Run OpenRV build (Rocky 9)
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          mkdir -p out
          BMD_E=""; NDI_E=""
          [ -n "$BMD_DECKLINK_SDK_ZIP_URL" ] && BMD_E="-e BMD_DECKLINK_SDK_ZIP_URL=$BMD_DECKLINK_SDK_ZIP_URL"
          [ -n "$NDI_SDK_URL" ] && NDI_E="-e NDI_SDK_URL=$NDI_SDK_URL"
          docker run --rm \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-rocky9 \
            $BMD_E $NDI_E \
            -v "${{ github.workspace }}/ci/linux:/ci:ro" \
            -v "${{ github.workspace }}/out:/out" \
            openrv-build-rocky9 \
            bash /ci/build_in_container.sh

      - name: Upload Rocky9 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky9
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-rocky9-x86_64.tar.gz

  linux-ubuntu:
    name: Linux (Ubuntu 22.04, experimental)
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (Ubuntu 22.04)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ci/linux/Dockerfile.ubuntu22.04
          load: true
          tags: openrv-build-ubuntu
          cache-from: type=gha,scope=ubuntu
          cache-to: type=gha,mode=max,scope=ubuntu
          push: false

      - name: Run OpenRV build (Ubuntu 22.04)
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          mkdir -p out
          BMD_E=""; NDI_E=""
          [ -n "$BMD_DECKLINK_SDK_ZIP_URL" ] && BMD_E="-e BMD_DECKLINK_SDK_ZIP_URL=$BMD_DECKLINK_SDK_ZIP_URL"
          [ -n "$NDI_SDK_URL" ] && NDI_E="-e NDI_SDK_URL=$NDI_SDK_URL"
          docker run --rm \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-ubuntu22.04 \
            $BMD_E $NDI_E \
            -v "${{ github.workspace }}/out:/out" \
            openrv-build-ubuntu

      - name: Upload Ubuntu artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: linux-ubuntu
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-ubuntu22.04-x86_64.tar.gz

  windows:
    name: Windows
    runs-on: windows-latest
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Windows)
        shell: pwsh
        run: |
          Write-Host "=== Disk before cleanup ==="
          Get-PSDrive -Name C | Format-List

          # Android SDK (large; not needed for OpenRV)
          if (Test-Path "C:\Android\android-sdk") {
            Write-Host "Removing C:\Android\android-sdk ..."
            Remove-Item -Recurse -Force "C:\Android\android-sdk" -ErrorAction SilentlyContinue
          }

          # Docker images and build cache (job does not use Docker)
          if (Get-Command docker -ErrorAction SilentlyContinue) {
            Write-Host "Pruning Docker..."
            docker system prune -af 2>$null
          }

          # Temp directories (small win, low risk)
          $tempPaths = @($env:TEMP, "C:\Users\runneradmin\AppData\Local\Temp")
          foreach ($p in $tempPaths) {
            if (Test-Path $p) {
              Get-ChildItem $p -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            }
          }

          Write-Host "=== Disk after cleanup ==="
          Get-PSDrive -Name C | Format-List

      # Resolve OpenRV tag to commit SHA for cache key (cache invalidates when tag is overwritten)
      - name: Get OpenRV tag commit SHA
        id: openrv-sha
        run: |
          SHA=$(git ls-remote "${{ env.OPENRV_REPO }}" "refs/tags/${{ env.OPENRV_TAG }}^{}" 2>/dev/null | cut -f1)
          [ -z "$SHA" ] && SHA=$(git ls-remote "${{ env.OPENRV_REPO }}" "refs/tags/${{ env.OPENRV_TAG }}" 2>/dev/null | cut -f1)
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "OpenRV tag ${{ env.OPENRV_TAG }} -> ${SHA}"
        shell: bash

      - name: Clone OpenRV (for pip cache key)
        run: |
          git clone --depth 1 --branch "${{ env.OPENRV_TAG }}" "${{ env.OPENRV_REPO }}" openrv-src
        shell: bash

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: openrv-src/requirements.txt

      - name: Ensure python3.exe
        run: |
          $py = (Get-Command python -ErrorAction SilentlyContinue).Source
          if ($py) {
            $dir = Split-Path $py
            $py3 = Join-Path $dir 'python3.exe'
            if (-not (Test-Path $py3)) { Copy-Item $py $py3 }
          }

      - name: Cache Qt
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: C:\Qt
          key: openrv-qt-6.5.3-msvc2019

      - name: Install Qt 6.5.3
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop 6.5.3 win64_msvc2019_64 -O C:\Qt -m qtwebchannel qtwebengine qtwebsockets qtmultimedia qtpositioning
        env:
          QT_HOME: C:\Qt\6.5.3\msvc2019_64

      - name: Cache Strawberry Perl
        id: cache-perl
        uses: actions/cache@v4
        with:
          path: C:\Strawberry
          key: openrv-strawberryperl

      - name: Install Strawberry Perl
        if: steps.cache-perl.outputs.cache-hit != 'true'
        run: choco install strawberryperl -y

      - name: Cache Rust
        id: cache-rust
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.USERPROFILE }}\.cargo
            ${{ env.USERPROFILE }}\.rustup
          key: openrv-rust

      - name: Install Rust
        if: steps.cache-rust.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe -UseBasicParsing
          .\rustup-init.exe -y
        shell: pwsh

      - name: Cache MSYS2
        id: cache-msys2
        uses: actions/cache@v4
        with:
          path: C:\msys64
          key: openrv-msys2-v1

      - name: Install MSYS2 and build tools
        if: steps.cache-msys2.outputs.cache-hit != 'true'
        run: |
          choco install msys2 -y
          $env:Path = "C:\msys64\usr\bin;$env:Path"
          bash -lc "pacman -Sy --noconfirm --needed mingw-w64-x86_64-autotools mingw-w64-x86_64-glew mingw-w64-x86_64-libarchive mingw-w64-x86_64-make mingw-w64-x86_64-meson mingw-w64-x86_64-toolchain autoconf automake bison flex git libtool nasm p7zip patch unzip zip"

      - name: Setup MSVC (nmake for OpenSSL build)
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0, 18.0)'

      - name: Setup MSVC developer environment (cl, link, INCLUDE, LIB for Meson/deps)
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download optional SDKs
        id: sdks
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          $bmdPath = ''
          $ndiRoot = ''
          if ($env:BMD_DECKLINK_SDK_ZIP_URL) {
            Write-Host "Downloading Blackmagic DeckLink SDK..."
            $bmdPath = "$env:RUNNER_TEMP\BMD_DeckLink_SDK.zip"
            Invoke-WebRequest -Uri $env:BMD_DECKLINK_SDK_ZIP_URL -OutFile $bmdPath -UseBasicParsing
          }
          if ($env:NDI_SDK_URL) {
            Write-Host "Downloading NDI SDK..."
            $ndiZip = "$env:RUNNER_TEMP\NDI_SDK.zip"
            Invoke-WebRequest -Uri $env:NDI_SDK_URL -OutFile $ndiZip -UseBasicParsing
            $ndiRoot = "$env:RUNNER_TEMP\ndi-sdk"
            New-Item -ItemType Directory -Path $ndiRoot -Force | Out-Null
            Expand-Archive -Path $ndiZip -DestinationPath $ndiRoot -Force
            $children = Get-ChildItem $ndiRoot -Directory
            if ($children.Count -eq 1) { $ndiRoot = $children[0].FullName }
          }
          # Export for subsequent steps
          "BMD_PATH=$bmdPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "NDI_ROOT=$ndiRoot" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: pwsh

      - name: Build OpenRV (Windows) - Clone
        run: |
          .\ci\windows\build_windows.ps1 -Phase Clone `
            -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV" `
            -BMDDeckLinkSdkZipPath "${{ env.BMD_PATH }}" -NDISdkRoot "${{ env.NDI_ROOT }}"
        shell: pwsh

      - name: Build OpenRV (Windows) - Python venv
        run: |
          .\ci\windows\build_windows.ps1 -Phase Venv `
            -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Build OpenRV (Windows) - Configure
        run: |
          .\ci\windows\build_windows.ps1 -Phase Configure `
            -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV" `
            -BMDDeckLinkSdkZipPath "${{ env.BMD_PATH }}" -NDISdkRoot "${{ env.NDI_ROOT }}"
        shell: pwsh

      - name: Restore OpenRV dependencies build cache
        id: deps-cache
        uses: actions/cache@v4
        with:
          path: C:\OpenRV\_build
          key: openrv-windows-deps-${{ env.OPENRV_TAG }}-${{ steps.openrv-sha.outputs.sha }}

      - name: Build OpenRV (Windows) - Dependencies
        if: steps.deps-cache.outputs.cache-hit != 'true'
        run: |
          .\ci\windows\build_windows.ps1 -Phase BuildDependencies `
            -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Build OpenRV (Windows) - Main executable
        run: |
          .\ci\windows\build_windows.ps1 -Phase BuildMain `
            -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Build OpenRV (Windows) - Verify
        run: |
          .\ci\windows\build_windows.ps1 -Phase Verify `
            -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Package OpenRV (Windows)
        run: |
          .\ci\windows\package_windows.ps1 -OpenRVRoot "C:\OpenRV" -Tag '${{ env.OPENRV_TAG }}' -OutDir dist
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: dist/OpenRV-${{ env.OPENRV_TAG }}-windows-x86_64.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [linux-rocky9, linux-ubuntu, windows]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: OpenRV ${{ github.ref_name }}
          draft: false
          files: |
            release-artifacts/linux-rocky9/*
            release-artifacts/windows/*
            release-artifacts/linux-ubuntu/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
