# OpenRV release build: triggered on push of tags matching v*
# Builds from upstream AcademySoftwareFoundation/OpenRV at the tag.
# Jobs: linux-rocky9, linux-rocky8, linux-ubuntu (optional), windows (required), release
name: OpenRV Release

on:
  push:
    tags:
      - 'v*'

env:
  OPENRV_TAG: ${{ github.ref_name }}
  OPENRV_REPO: https://github.com/AcademySoftwareFoundation/OpenRV.git

jobs:
  linux-rocky9:
    name: Linux (Rocky 9)
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Clone OpenRV
        run: |
          git clone --depth 1 --branch "${{ env.OPENRV_TAG }}" "${{ env.OPENRV_REPO }}" openrv-src

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build vanilla Docker image (upstream Rocky 9 Dockerfile)
        uses: docker/build-push-action@v6
        with:
          context: openrv-src
          file: openrv-src/dockerfiles/Dockerfile.Linux-Rocky9-CY2024
          load: true
          tags: openrv-rocky9-base
          push: false

      # Use host Docker (not Buildx) so FROM openrv-rocky9-base resolves from the image loaded in the previous step
      - name: Build extended Docker image (vanilla + GL/devel packages)
        run: docker build -f ci/linux/Dockerfile.rocky9-cy2024 -t openrv-build-rocky9 .

      - name: Run OpenRV build (Rocky 9)
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          set -o pipefail
          mkdir -p out
          mkdir -p out/logs
          BMD_E=""; NDI_E=""
          [ -n "$BMD_DECKLINK_SDK_ZIP_URL" ] && BMD_E="-e BMD_DECKLINK_SDK_ZIP_URL=$BMD_DECKLINK_SDK_ZIP_URL"
          [ -n "$NDI_SDK_URL" ] && NDI_E="-e NDI_SDK_URL=$NDI_SDK_URL"
          docker run --rm \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-rocky9 \
            $BMD_E $NDI_E \
            -v "${{ github.workspace }}/ci/linux:/ci:ro" \
            -v "${{ github.workspace }}/out:/out" \
            openrv-build-rocky9 \
            bash /ci/build_in_container.sh 2>&1 | tee out/logs/build-linux-rocky9.log

      - name: Upload Rocky9 logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky9-logs
          if-no-files-found: warn
          path: out/logs/**

      - name: Upload Rocky9 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky9
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-rocky9-x86_64.tar.gz

  linux-rocky8:
    name: Linux (Rocky 8)
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Clone OpenRV
        run: |
          git clone --depth 1 --branch "${{ env.OPENRV_TAG }}" "${{ env.OPENRV_REPO }}" openrv-src

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build vanilla Docker image (upstream Rocky 8 Dockerfile)
        uses: docker/build-push-action@v6
        with:
          context: openrv-src
          file: openrv-src/dockerfiles/Dockerfile.Linux-Rocky8
          load: true
          tags: openrv-rocky8-base
          push: false

      # Use host Docker (not Buildx) so FROM openrv-rocky8-base resolves from the image loaded in the previous step
      - name: Build extended Docker image (vanilla + GL/devel packages)
        run: docker build -f ci/linux/Dockerfile.rocky8-extended -t openrv-build-rocky8 .

      - name: Run OpenRV build (Rocky 8)
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          set -o pipefail
          mkdir -p out
          mkdir -p out/logs
          BMD_E=""; NDI_E=""
          [ -n "$BMD_DECKLINK_SDK_ZIP_URL" ] && BMD_E="-e BMD_DECKLINK_SDK_ZIP_URL=$BMD_DECKLINK_SDK_ZIP_URL"
          [ -n "$NDI_SDK_URL" ] && NDI_E="-e NDI_SDK_URL=$NDI_SDK_URL"
          docker run --rm \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-rocky8 \
            -e RV_VFX_PLATFORM=CY2023 \
            $BMD_E $NDI_E \
            -v "${{ github.workspace }}/ci/linux:/ci:ro" \
            -v "${{ github.workspace }}/out:/out" \
            openrv-build-rocky8 \
            bash /ci/build_in_container.sh 2>&1 | tee out/logs/build-linux-rocky8.log

      - name: Upload Rocky8 logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky8-logs
          if-no-files-found: warn
          path: out/logs/**

      - name: Upload Rocky8 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky8
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-rocky8-x86_64.tar.gz

  linux-ubuntu:
    name: Linux (Ubuntu 22.04, experimental)
    runs-on: ubuntu-latest
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (Ubuntu 22.04)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ci/linux/Dockerfile.ubuntu22.04
          load: true
          tags: openrv-build-ubuntu
          push: false

      - name: Prepare build cache directory (Ubuntu 22.04)
        run: |
          mkdir -p ${{ github.workspace }}/openrv-build-cache-ubuntu
          chmod 777 ${{ github.workspace }}/openrv-build-cache-ubuntu

      - name: Run OpenRV build (Ubuntu 22.04)
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          set -o pipefail
          mkdir -p out
          mkdir -p out/logs
          BMD_E=""; NDI_E=""
          [ -n "$BMD_DECKLINK_SDK_ZIP_URL" ] && BMD_E="-e BMD_DECKLINK_SDK_ZIP_URL=$BMD_DECKLINK_SDK_ZIP_URL"
          [ -n "$NDI_SDK_URL" ] && NDI_E="-e NDI_SDK_URL=$NDI_SDK_URL"
          docker run --rm \
            --entrypoint bash \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-ubuntu22.04 \
            $BMD_E $NDI_E \
            -v "${{ github.workspace }}/ci/linux:/ci:ro" \
            -e OPENRV_BUILD_CACHE_DIR=/home/rv/openrv-build-cache \
            -v "${{ github.workspace }}/openrv-build-cache-ubuntu:/home/rv/openrv-build-cache" \
            -v "${{ github.workspace }}/out:/out" \
            openrv-build-ubuntu \
            /ci/build_in_container.sh 2>&1 | tee out/logs/build-linux-ubuntu22.04.log

      - name: Upload Ubuntu logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-ubuntu-logs
          if-no-files-found: warn
          path: out/logs/**

      - name: Upload Ubuntu artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: linux-ubuntu
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-ubuntu22.04-x86_64.tar.gz

  windows:
    name: Windows
    runs-on: windows-latest
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Windows)
        shell: pwsh
        run: |
          Write-Host "=== Disk before cleanup ==="
          Get-PSDrive -Name C | Format-List

          # Android SDK (large; not needed for OpenRV)
          if (Test-Path "C:\Android\android-sdk") {
            Write-Host "Removing C:\Android\android-sdk ..."
            Remove-Item -Recurse -Force "C:\Android\android-sdk" -ErrorAction SilentlyContinue
          }

          # Docker images and build cache (job does not use Docker)
          if (Get-Command docker -ErrorAction SilentlyContinue) {
            Write-Host "Pruning Docker..."
            docker system prune -af 2>$null
          }

          # Temp directories (small win, low risk)
          $tempPaths = @($env:TEMP, "C:\Users\runneradmin\AppData\Local\Temp")
          foreach ($p in $tempPaths) {
            if (Test-Path $p) {
              Get-ChildItem $p -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            }
          }

          Write-Host "=== Disk after cleanup ==="
          Get-PSDrive -Name C | Format-List

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Qt 6.5.3
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop 6.5.3 win64_msvc2019_64 -O C:\Qt -m qtwebchannel qtwebengine qtwebsockets qtmultimedia qtpositioning
        env:
          QT_HOME: C:\Qt\6.5.3\msvc2019_64

      - name: Install Strawberry Perl
        run: choco install strawberryperl -y

      - name: Install Rust
        run: |
          Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe -UseBasicParsing
          .\rustup-init.exe -y
        shell: pwsh

      - name: Install MSYS2 and build tools
        run: |
          choco install msys2 -y
          $env:Path = "C:\msys64\usr\bin;$env:Path"
          bash -lc "pacman -Sy --noconfirm --needed mingw-w64-x86_64-autotools mingw-w64-x86_64-glew mingw-w64-x86_64-libarchive mingw-w64-x86_64-make mingw-w64-x86_64-meson mingw-w64-x86_64-toolchain autoconf automake bison flex git libtool nasm p7zip patch unzip zip"

      - name: Setup MSVC (nmake for OpenSSL build)
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[17.0, 18.0)'

      - name: Setup MSVC developer environment (cl, link, INCLUDE, LIB for Meson/deps)
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download optional SDKs
        id: sdks
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          $bmdPath = ''
          $ndiRoot = ''
          if ($env:BMD_DECKLINK_SDK_ZIP_URL) {
            Write-Host "Downloading Blackmagic DeckLink SDK..."
            $bmdPath = "$env:RUNNER_TEMP\BMD_DeckLink_SDK.zip"
            Invoke-WebRequest -Uri $env:BMD_DECKLINK_SDK_ZIP_URL -OutFile $bmdPath -UseBasicParsing
          }
          if ($env:NDI_SDK_URL) {
            Write-Host "Downloading NDI SDK..."
            $ndiZip = "$env:RUNNER_TEMP\NDI_SDK.zip"
            Invoke-WebRequest -Uri $env:NDI_SDK_URL -OutFile $ndiZip -UseBasicParsing
            $ndiRoot = "$env:RUNNER_TEMP\ndi-sdk"
            New-Item -ItemType Directory -Path $ndiRoot -Force | Out-Null
            Expand-Archive -Path $ndiZip -DestinationPath $ndiRoot -Force
            $children = Get-ChildItem $ndiRoot -Directory
            if ($children.Count -eq 1) { $ndiRoot = $children[0].FullName }
          }
          # Export for subsequent steps
          "BMD_PATH=$bmdPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "NDI_ROOT=$ndiRoot" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: pwsh

      - name: Build OpenRV (Windows) - Clone
        run: .\ci\windows\build_windows.ps1 -Phase Clone -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV" -BMDDeckLinkSdkZipPath "${{ env.BMD_PATH }}" -NDISdkRoot "${{ env.NDI_ROOT }}"
        shell: pwsh

      - name: Build OpenRV (Windows) - Python venv
        run: .\ci\windows\build_windows.ps1 -Phase Venv -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Build OpenRV (Windows) - Configure
        run: .\ci\windows\build_windows.ps1 -Phase Configure -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV" -BMDDeckLinkSdkZipPath "${{ env.BMD_PATH }}" -NDISdkRoot "${{ env.NDI_ROOT }}"
        shell: pwsh

      - name: Build OpenRV (Windows) - Dependencies
        run: .\ci\windows\build_windows.ps1 -Phase BuildDependencies -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Build OpenRV (Windows) - Main executable
        run: .\ci\windows\build_windows.ps1 -Phase BuildMain -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Build OpenRV (Windows) - Verify
        run: .\ci\windows\build_windows.ps1 -Phase Verify -Tag "${{ env.OPENRV_TAG }}" -WorkDir "C:\OpenRV"
        shell: pwsh

      - name: Upload Windows build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-logs
          if-no-files-found: warn
          path: |
            C:\OpenRV\_build_logs\*.log
            C:\OpenRV\_build\**\*.log
            C:\OpenRV\_build\**\config.log

      - name: Package OpenRV (Windows)
        run: .\ci\windows\package_windows.ps1 -OpenRVRoot "C:\OpenRV" -Tag "${{ env.OPENRV_TAG }}" -OutDir dist
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: dist/OpenRV-${{ env.OPENRV_TAG }}-windows-x86_64.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [linux-rocky9, linux-rocky8, linux-ubuntu, windows]
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Read OpenRV upstream commit message
        id: upstream-meta
        shell: bash
        run: |
          set -euo pipefail
          git init openrv-meta
          cd openrv-meta
          git remote add origin "${{ env.OPENRV_REPO }}"
          git fetch --depth 1 origin "refs/tags/${{ env.OPENRV_TAG }}:refs/tags/${{ env.OPENRV_TAG }}"
          SHA=$(git rev-list -n 1 "${{ env.OPENRV_TAG }}")
          SUBJECT=$(git log -1 --format=%s "$SHA")
          BODY=$(git log -1 --format=%b "$SHA")
          {
            echo "sha=$SHA"
            echo "subject<<EOF"
            echo "$SUBJECT"
            echo "EOF"
            echo "body<<EOF"
            echo "$BODY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: OpenRV ${{ github.ref_name }}
          draft: false
          body: |
            Upstream OpenRV commit for `${{ env.OPENRV_TAG }}`:
            `${{ steps.upstream-meta.outputs.sha }}`

            ${{ steps.upstream-meta.outputs.subject }}

            ${{ steps.upstream-meta.outputs.body }}
          files: |
            release-artifacts/linux-rocky9/*
            release-artifacts/linux-rocky8/*
            release-artifacts/windows/*
            release-artifacts/linux-ubuntu/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
