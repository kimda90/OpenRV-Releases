name: OpenRV Release - Rocky 9

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  OPENRV_TAG: ${{ github.ref_name }}
  OPENRV_REPO: https://github.com/AcademySoftwareFoundation/OpenRV.git

jobs:
  linux-rocky9:
    name: Linux (Rocky 9)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Aggressive Disk Cleanup (Ubuntu)
        run: |
          set -euxo pipefail
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          docker system prune -af --volumes || true
          df -h

      - name: Clone OpenRV
        run: |
          git clone --depth 1 --branch "${{ env.OPENRV_TAG }}" "${{ env.OPENRV_REPO }}" openrv-src

      - name: Resolve upstream tag commit
        shell: bash
        run: |
          set -euo pipefail
          TAG_REF="refs/tags/${{ env.OPENRV_TAG }}"
          COMMIT_SHA="$(git ls-remote "${{ env.OPENRV_REPO }}" "${TAG_REF}^{}" | cut -f1)"
          if [[ -z "$COMMIT_SHA" ]]; then
            COMMIT_SHA="$(git ls-remote "${{ env.OPENRV_REPO }}" "${TAG_REF}" | cut -f1)"
          fi
          if [[ -z "$COMMIT_SHA" ]]; then
            echo "ERROR: could not resolve upstream commit for ${TAG_REF}"
            exit 1
          fi
          echo "UPSTREAM_SHA=${COMMIT_SHA}" >> "$GITHUB_ENV"
          echo "UPSTREAM_SHA_SHORT=${COMMIT_SHA:0:12}" >> "$GITHUB_ENV"

      - name: Restore Rocky9 build cache (_build)
        id: restore-rocky9-build-cache
        uses: actions/cache/restore@v4
        with:
          path: openrv-build-cache-rocky9
          key: openrv-rocky9-build-${{ env.OPENRV_TAG }}-${{ env.UPSTREAM_SHA_SHORT }}-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            openrv-rocky9-build-${{ env.OPENRV_TAG }}-${{ env.UPSTREAM_SHA_SHORT }}-

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build vanilla Docker image (upstream Rocky 9 Dockerfile)
        uses: docker/build-push-action@v6
        with:
          context: openrv-src
          file: openrv-src/dockerfiles/Dockerfile.Linux-Rocky9-CY2024
          load: true
          tags: openrv-rocky9-base
          push: false
          cache-from: type=gha,scope=rocky9
          cache-to: type=gha,mode=max,scope=rocky9

      - name: Build extended Docker image (vanilla + GL/devel packages)
        run: docker build -f ci/linux/Dockerfile.rocky9-cy2024 -t openrv-build-rocky9 .

      - name: Reclaim Space Before Build (Rocky 9)
        run: |
          set -euxo pipefail
          rm -rf openrv-src
          docker image rm openrv-rocky9-base || true
          docker builder prune -af || true
          docker system df || true
          df -h

      - name: Run OpenRV build (Rocky 9)
        env:
          BMD_DECKLINK_SDK_ZIP_URL: ${{ secrets.BMD_DECKLINK_SDK_ZIP_URL }}
          NDI_SDK_URL: ${{ secrets.NDI_SDK_URL }}
        run: |
          set -o pipefail
          mkdir -p out
          mkdir -p out/logs
          mkdir -p openrv-build-cache-rocky9
          chmod -R 0777 openrv-build-cache-rocky9 || true
          BMD_E=""; NDI_E=""
          [ -n "$BMD_DECKLINK_SDK_ZIP_URL" ] && BMD_E="-e BMD_DECKLINK_SDK_ZIP_URL=$BMD_DECKLINK_SDK_ZIP_URL"
          [ -n "$NDI_SDK_URL" ] && NDI_E="-e NDI_SDK_URL=$NDI_SDK_URL"
          docker run --rm \
            -e OPENRV_TAG="${{ env.OPENRV_TAG }}" \
            -e OPENRV_REPO="${{ env.OPENRV_REPO }}" \
            -e DISTRO_SUFFIX=linux-rocky9 \
            -e OPENRV_BUILD_CACHE_DIR=/home/rv/openrv-build-cache \
            $BMD_E $NDI_E \
            -v "${{ github.workspace }}/ci/linux:/ci:ro" \
            -v "${{ github.workspace }}/out:/out" \
            -v "${{ github.workspace }}/openrv-build-cache-rocky9:/home/rv/openrv-build-cache" \
            openrv-build-rocky9 \
            bash /ci/build_in_container.sh 2>&1 | tee out/logs/build-linux-rocky9.log

      - name: Save Rocky9 build cache (_build)
        if: always()
        uses: actions/cache/save@v4
        with:
          path: openrv-build-cache-rocky9
          key: ${{ steps.restore-rocky9-build-cache.outputs.cache-primary-key }}

      - name: Upload Rocky9 logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky9-logs
          if-no-files-found: warn
          path: out/logs/**

      - name: Upload Rocky9 artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: linux-rocky9
          path: out/OpenRV-${{ env.OPENRV_TAG }}-linux-rocky9-x86_64.tar.xz

      - name: Generate Release Body From Upstream OpenRV Tag Message
        if: success()
        shell: bash
        run: |
          set -euo pipefail
          rm -rf openrv-meta
          git init openrv-meta
          cd openrv-meta
          git remote add origin "${{ env.OPENRV_REPO }}"

          TAG="${{ env.OPENRV_TAG }}"
          TAG_REF="refs/tags/${TAG}"

          TAG_OBJ_SHA="$(git ls-remote origin "$TAG_REF" | cut -f1)"
          COMMIT_SHA="$(git ls-remote origin "${TAG_REF}^{}" | cut -f1)"

          if [[ -z "$TAG_OBJ_SHA" && -z "$COMMIT_SHA" ]]; then
            echo "ERROR: Could not resolve upstream tag '${TAG}' in ${{ env.OPENRV_REPO }}"
            exit 1
          fi

          if [[ -z "$COMMIT_SHA" ]]; then
            COMMIT_SHA="$TAG_OBJ_SHA"
          fi

          if [[ -n "$TAG_OBJ_SHA" ]]; then
            git fetch --depth 1 origin "$TAG_OBJ_SHA"
          fi
          if [[ -n "$COMMIT_SHA" && "$COMMIT_SHA" != "$TAG_OBJ_SHA" ]]; then
            git fetch --depth 1 origin "$COMMIT_SHA"
          fi

          TAG_MESSAGE=""
          TAG_TYPE=""
          if [[ -n "$TAG_OBJ_SHA" ]]; then
            TAG_TYPE="$(git cat-file -t "$TAG_OBJ_SHA" 2>/dev/null || true)"
            if [[ "$TAG_TYPE" == "tag" ]]; then
              TAG_MESSAGE="$(git cat-file -p "$TAG_OBJ_SHA" | sed '1,/^$/d' | sed '/^-----BEGIN PGP SIGNATURE-----/,$d')"
            fi
          fi

          FALLBACK_NOTE=""
          if [[ -z "${TAG_MESSAGE//[[:space:]]/}" ]]; then
            TAG_MESSAGE="$(git show -s --format=%B "$COMMIT_SHA")"
            FALLBACK_NOTE="_Note: upstream tag is lightweight (no annotation); showing commit message._"
          fi

          cd ..

          {
            echo "Upstream OpenRV tag message for \`${TAG}\`:"
            echo "\`$COMMIT_SHA\`"
            echo
            if [[ -n "$FALLBACK_NOTE" ]]; then
              echo "$FALLBACK_NOTE"
              echo
            fi
            echo "$TAG_MESSAGE"
          } > release-body.md

      - name: Publish Rocky9 Release Asset
        if: success()
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          TITLE="OpenRV ${TAG}"
          ASSET="out/OpenRV-${{ env.OPENRV_TAG }}-linux-rocky9-x86_64.tar.xz"
          MAX_RELEASE_ASSET_BYTES=2147483648
          SPLIT_CHUNK_SIZE=1900m

          # Ensure the release exists; ignore the race if another workflow creates it first.
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --title "$TITLE" \
              --notes-file release-body.md \
              --verify-tag || true
          fi

          upload_with_retry() {
            local file="$1"
            for attempt in 1 2 3; do
              if gh release upload "$TAG" "$file" --clobber; then
                return 0
              fi
              if [ "$attempt" -eq 3 ]; then
                echo "ERROR: failed to upload $file after $attempt attempts"
                return 1
              fi
              sleep $((attempt * 10))
            done
          }

          ASSET_SIZE="$(stat -c%s "$ASSET")"
          echo "Asset size: ${ASSET_SIZE} bytes"

          if [ "$ASSET_SIZE" -le "$MAX_RELEASE_ASSET_BYTES" ]; then
            upload_with_retry "$ASSET"
            exit 0
          fi

          echo "Asset exceeds GitHub Release limit (${MAX_RELEASE_ASSET_BYTES} bytes). Splitting into parts..."
          split -b "$SPLIT_CHUNK_SIZE" -d -a 3 "$ASSET" "${ASSET}.part."
          sha256sum "${ASSET}.part."* > "${ASSET}.parts.sha256"
          cat > "${ASSET}.parts.README.txt" <<EOF
          This Rocky 9 artifact exceeded GitHub's per-asset 2 GiB limit and was uploaded in parts.

          Reconstruct:
            cat $(basename "${ASSET}").part.* > $(basename "${ASSET}")
            sha256sum -c $(basename "${ASSET}").parts.sha256
          EOF

          upload_with_retry "${ASSET}.parts.sha256"
          upload_with_retry "${ASSET}.parts.README.txt"
          for part in "${ASSET}.part."*; do
            upload_with_retry "$part"
          done
